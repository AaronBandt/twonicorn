<!--!  Copyright 2015 CityGrid Media, LLC Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
<div metal:use-macro="layout">
    <div metal:fill-slot="content">

      <script src="/static/jquery-2.1.3.min.js"></script>
      <script src="/static/jquery.validate.min.js"></script>
      <script src="/static/additional-methods.min.js"></script>
      <script>
        // Only show package name for types that require it.
        $(function() {
          $(document.body).on('change', 'project_type' ,function(){
            if ($.inArray($(this).val(), ["python", "tar"]) > -1) {
                $( "#pkg_td"+pkg_td_idx[1] ).show();
                $( "#package_name"+pkg_td_idx[1] ).prop('required',true);
            } else {
                $( "#pkg_td"+pkg_td_idx[1] ).hide();
                $( "#package_name"+pkg_td_idx[1] ).prop('required',false);
            }
          });

          $.validator.addMethod("projectRegex", function(value, element) {
              return this.optional(element) || /^[a-z0-9\-\s]+$/i.test(value);
          }, "Project name must contain only letters, numbers, spaces, or dashes.");
      
          $('#submit').validate({
              wrapper: "span",
              errorClass: "invalid",
              rules: {
                  project_type: {
                      required: true,
                  },
                  project_name: {
                      required: true,
                      projectRegex: true,
                      minlength: 5
                  },
                  code_review: {
                      required: true,
                  },
                  job_prefix: {
                      required: true,
                      lettersonly: true,
                      rangelength: [2, 20]
                  },
                  job_server: {
                      required: true,
                  }
              },
              messages: {
                  "project_name": {
                      required: "You must enter a project name",
                      loginRegex: "Project format not valid"
                  },
                  "job_prefix": {
                      required: "You must enter a job prefix"
                  }
              },
              errorPlacement: function(error, element) {
                  error.insertAfter(element);
      //            error.appendTo(element.parent().next());
              }
          });

        });

      </script>

      <div tal:condition="not confirm and not processed" class="center" id="ss_form_c">
        <form id="submit" class="ss_form" action="/ss" method="POST" onsubmit="return(validate());">
          <input type="hidden" name="form.preprocess"/>
     
            <div>
              <h2>Project type</h2>
            </div>
            <div>
                <p>The type of application you are developing. This will determine which Jenkins job templates to use, and how the application will be created in twonicorn.
                <p>
                <select id="project_type" name="project_type" title="Please select a project type.">
                  <option value="">Select...</option>
                  <option tal:repeat="item artifact_types" tal:attributes="value item.name; selected item.name == results.project_type" tal:content="item.name">some_type</option>
                </select>
            </div>
            <div>
              <h2>Project Name</h2>
            </div>
            <div>
                <p>The name of the project. This will be used to name the git repos, Jenkins jobs, deployment directory paths, and must match the name you set your package/artifact to for jar and python projects.
                <p>
                <input type="text" 
                       id="project_name"
                       name="project_name"
                       placeholder="Name of your project"
                       tal:attributes="value results.project_name if results.project_name else None"
                       title="Project name must contain only letters, numbers, spaces, or dashes."/>
            </div>
            <div>
              <h2>Code Review?</h2>
            </div>
            <div>
                <p>Whether or not you would like Gerrit code review enabled for your project.
                <p>
                <select id="code_review" name="code_review" required title="Please select if you would like code review or not.">
                  <option value="no_review" tal:attributes="selected results.code_review == 'no_review'">No</option>
                  <option value="review" tal:attributes="selected results.code_review == 'review'">Yes</option>
                </select>
            </div>
            <div>
              <h2>Job Prefix</h2>
            </div>
            <div>
                <p>A two to twenty character prefix to be used in the Jenkins job names.
                <p>
              <input type="text" 
                     id="job_prefix" 
                     name="job_prefix" 
                     placeholder="PREFIX" tal:attributes="value results.job_prefix if results.job_prefix else None"
                     title="Prefix must be between 2 and 20 letters only."/>
            </div>
            <div>
              <h2>Job Server</h2>
            </div>
            <div>
                <p>What Jenkins instances you want your build/run jobs created on.
                <p>
                <select id="job_server" name="job_server" title="Please select your jenkins instance.">
                  <option value="">Select...</option>
                  <option tal:repeat="item jenkins_instances" tal:attributes="value item.instance_name ; selected item.instance_name == results.job_server" tal:content="item.instance_name">jenkins</option>
                </select>
            </div>
            <div>
              <h2>ABS Skeleton Job</h2>
            </div>
            <div>
                <p>Would you like an ABS skeleton job created with the twonicorn execute shell?
                <p>
                  <input id="ss_cb" type="checkbox" name="job_abs" value="job_abs" tal:attributes="checked 'True' if results.job_abs else None">Create abs skeleton job?</input>
            </div>
            <div id="ss_submit">
              <input id="submit_btn" class="button" type="submit" name="submit" value="Review"/>
            </div>
        </form>

      </div>

      <div tal:condition="confirm">
        <div class="center">
          <div>
            <div class="center">
              <h2>We are ready to create the following resources. Continue?</h2>
            </div>
            <div class="cp_form">
              <ul>
                <li>
                  <h2>Git Repos</h2>
                </li>
                <li tal:content="'Code Review: Yes' if results.code_review == 'review' else 'Code Review: No'">
                <li>
                  ${results.git_code_repo}
                </li>
                <li>
                  ${results.git_conf_repo}
                </li>
              </ul>
            </div>
            <div class="cp_form">
              <ul>
                <li>
                  <h2>Jenkins Jobs</h2>
                </li>
                <li tal:condition="results['code_review'] == 'review'">
                  ${results.job_review_name}
                </li>
                <li>
                  ${results.job_code_name}
                </li>
                <li>
                  ${results.job_conf_name}
                </li>
                  <li tal:content="results['job_abs_name'] if results['job_abs'] else 'No abs job requested'">
                </li>
              </ul>
            </div>
            <div class="cp_form">
              <ul>
                <li>
                  <h2>Installation dirs</h2>
                </li>
                <li>
                  ${results.dir_app}
                </li>
                <li>
                  ${results.dir_conf}
                </li>
              </ul>
            </div>
          </div>
          <div id="ss_submit" class="center">
                <form class="cp_form" action="/ss" method="POST">
                  <input type="hidden" name="form.confirm"/>
                  <input class="button" type="submit" name="submit" value="Confirm"/>
                </form>
                <form class="cp_form" action="/ss" method="POST">
                  <input type="hidden" name="form.edit"/>
                  <input type="hidden" name="project_type" value="${results.project_type}"/>
                  <input type="hidden" name="project_name" value="${results.project_name}"/>
                  <input type="hidden" name="code_review" value="${results.code_review}"/>
                  <input type="hidden" name="job_prefix" value="${results.job_prefix}"/>
                  <input type="hidden" name="job_server" value="${results.job_server}"/>
                  <input type="hidden" name="job_abs" value="${results.job_abs}"/>
                  <input class="button" type="submit" name="submit" value="Edit"/>
                </form>
          </div>
        </div>
      </div> <!-- confirm -->

      <div tal:condition="processed">
        <p>SOON.
      </div> <!-- processed -->

  </div>
</div>

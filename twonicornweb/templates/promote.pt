<div metal:use-macro="layout">
    <div metal:fill-slot="content">

    <div id="promote_main">

      <p tal:condition="not denied and not state">
        Give us da money, Lebowski! This page should display paginated list of promotions
        <h3>TODO</h3>
        <ul>
          <li>search for candidates via nodegroup, application id, or deploy id</li>
          <li>Make table sortable by column</li>
        </ul>
      </p>
  
      <div id="error" tal:condition="denied">
          <p class="error">
          <img src="static/logo_medium.gif">
          </p>
  
          <h2 class="error" tal:condition="message" tal:content="message"/>
  
      </div>

      <div tal:condition="not denied and commit == 'false'">
 
        <h1 id="promote" tal:condition="state == '3' and to_env == 'prd'">
        Stage for production?
        </h1>

        <h1 id="promote" tal:condition="state != '3' and to_env != 'prd'">
        Promotoe to ${to_env}?
        </h1>

        <p id="promote">
        <table width="100%"> 
          <tr>
            <th>Application Name</th>
            <th>Deploy Path</th>
            <th>Revision</th>
            <th>Branch/Tag</th>
            <th>Repo</th>
            <th>Artifact Type</th>
            <th>URL Location</th>
            <th>Created Date</th>
          </tr>

          <tr tal:repeat="item promote">
            <!--! Do some reformatting of the urls to make them useful -->
            <?python
                if promote[item]['repo'] == 'gerrit':
                    r = promote[item]['url_location'].rpartition('/')
                    promote[item]['url_location'] = r[0] + r[1] + 'git/gitweb.cgi?p=' + r[2] + '.git;a=summary'
                if promote[item]['repo'] == 'subversion':
                    promote[item]['url_location'] = promote[item]['url_location'] +  '/' + promote[item]['env'] + '/?p=' + promote[item]['revision']
            ?>
            <td tal:content="promote[item]['application_name']">myapp</td>
            <td tal:content="promote[item]['deploy_path']" tal:attributes="title 'Deploy ID: ' + str(promote[item]['deploy_id'])">/app/something</td>
            <td tal:content="promote[item]['revision'] [:8]">12345</td>
            <td tal:content="promote[item]['branch']">trunk</td>
            <td tal:content="promote[item]['repo']">12345</td>
            <td tal:content="promote[item]['artifact_type']">12345</td>
            <td><a href="http://code.ctgrd.com/my/awesome/artifact.war"
                   title="some description"
                   tal:attributes="href promote[item]['url_location']; title promote[item]['url_location']"
                   tal:content="promote[item]['suffix']">Artifacts By nodegroupLink</a></td>
            <td tal:content="promote[item]['created']">12345</td>
          </tr>
        </table>
        </p>

        <p>
          <form method="POST" tal:attributes="action '/promote?deploy_id=%s&artifact_id=%s&to_env=%s&state=%s&commit=true' %
                                             (deploy_id,
                                               artifact_id,
                                               to_env,
                                               to_state
                                              );">
           <input type="hidden" name="form.submitted"/>
           <p>
           <input class="button" type="submit" name="submit" value="Stage"/>
           <a href="/"><input class="button" type="button" value="Cancel" /></a>
           </p>
        </p>

      </div>

      <div tal:condition="not denied and state == '3' and commit == 'true'">
        <p id="promote">
        <table width="100%">
          <tr class="subh">
            <td class="subh">Success!</td>
            <td class="subh_app" colspan="8" tal:condition="state == '3' and to_env == 'prd'" tal:content="'Successfully staged artifact id to production:  ' + artifact_id">0</td>
            <td class="subh_app" colspan="8" tal:condition="state != '3' and to_env != 'prd'" tal:content="'Successfully promoted artifact id to %s:  %s' % (to_env,artifact_id)">0</td>
          </tr>
        </table">
      </div>
  
    </div>

  </div>
</div>
